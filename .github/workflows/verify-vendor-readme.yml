name: Verify vendor README

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-vendor-docs:
    name: Check vendor README changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run verifier script
        run: |
          python3 tools/verify_vendor_readme.py

      - name: Fail if vendor README changed without proper label
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          set -euo pipefail
          BASE=${{ github.event.pull_request.base.sha }}
          HEAD=${{ github.event.pull_request.head.sha }}
          changed=$(git diff --name-only "$BASE" "$HEAD" || true)
          echo "Changed files:\n$changed"
          target="internal/docs/vendor/bmd-dctl/README.md"
          if echo "$changed" | grep -q "^$target$"; then
            echo "Vendor README was modified in this PR. Verifying PR labels..."
            python3 - <<'PY'
import json, os, sys
event = json.load(open(os.environ['GITHUB_EVENT_PATH']))
labels = [l.get('name','') for l in event.get('pull_request',{}).get('labels',[])]
print('PR labels:', labels)
if 'vendor-docs-update' not in labels:
    print("ERROR: vendor README was modified but PR is missing the 'vendor-docs-update' label.")
    print("If this change corresponds to an official BMD vendor release, add the label and include the vendor release reference in the PR description.")
    sys.exit(1)
else:
    print("vendor-docs-update label present â€” allow change.")
PY
          else
            echo "Vendor README not changed; OK"
          fi
